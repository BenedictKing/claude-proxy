# 版本历史

## v1.2.0 - 2025-09-19

### ✨ 新功能

- **Web管理界面全面升级**: 添加了完整的Web管理面板，支持可视化管理API渠道
- **模型映射功能**: 支持将请求中的模型名重定向到目标模型（如 "opus" → "claude-3-5-sonnet"）
- **渠道置顶功能**: 支持将常用渠道置顶显示，提升管理效率
- **API密钥故障转移**: 实现多密钥负载均衡和自动故障转移机制
- **ESC键快捷操作**: 编辑渠道modal支持ESC键快速关闭

### 🎨 UI/UX 优化

- **暗色模式支持**: 全面支持暗色模式，自动适配系统主题设置
- **渠道卡片重设计**: 采用现代化设计语言，提升视觉体验
- **绿色主题边框**: 统一使用绿色主题色，提升界面一致性
- **密钥数量优化**: 将密钥数量显示移至管理标题栏，界面更紧凑
- **模型选择优化**: 源模型名改为下拉选择（opus/sonnet/haiku），避免输入错误

### 🐛 Bug 修复

- **TypeScript类型错误**: 修复变量作用域相关的类型检查错误
- **CSS变量规范**: 根据Vuetify官方文档修复CSS变量使用方式
- **Header配色问题**: 修复编辑渠道modal在暗色模式下的配色问题
- **图标颜色统一**: 统一modal内图标颜色，保持视觉一致性
- **负载均衡策略**: 修复上游负载均衡策略不生效的问题

### ♻️ 重构

- **项目结构**: 重构为monorepo架构，分离前后端代码
- **渠道卡片样式**: 全面重构渠道卡片组件，优化代码结构
- **主题系统**: 基于Vuetify最佳实践重构主题系统

### ⚙️ 其他

- **构建系统**: 添加TypeScript类型检查和构建验证
- **发布流程**: 完善版本发布指南和自动化流程

## v1.1.0 - 2025-09-17

### 🚀 重大优化更新

这个版本专注于代码质量提升，大幅优化了字符串处理、正则表达式使用和代码结构。

#### ✨ 代码优化

- **SSE 数据解析优化**: 
  - 统一使用正则表达式 `/^data:\s*(.*)$/` 处理 Server-Sent Events 数据
  - 支持多种 SSE 格式（`data:`、`data: `、`data:  ` 等）
  - 提升解析健壮性，减少代码复杂度

- **Bearer Token 处理简化**:
  - 使用正则表达式 `/^bearer\s+/i` 替代复杂的字符串判断
  - 代码行数减少 60%，性能提升明显

- **敏感头部处理重构**:
  - 使用函数式的 `replace()` 回调处理 Authorization 头
  - 统一 API Key 掩码逻辑，提升安全性

- **请求头过滤优化**:
  - 缓存 `toLowerCase()` 转换结果，避免重复计算
  - 提升请求处理性能

- **API Key 掩码函数简化**:
  - 使用 `slice()` 替代 `substring()`
  - 条件逻辑简化，代码更清晰

- **参数解析现代化**:
  - 传统 `for` 循环重构为函数式 `reduce()`
  - 使用正则表达式简化命令行参数解析

#### 🧹 代码重构

- **重复代码消除**:
  - 提取 `normalizeClaudeRole` 函数到 `utils.ts` 共享模块
  - 遵循 DRY 原则，便于维护

- **User-Agent 检查优化**:
  - 使用正则表达式 `/^claude-cli/i` 进行大小写不敏感匹配
  - 提升代码可读性

#### 🔧 构建系统改进

- **新增构建脚本**:
  - 添加 `bun run build` 命令用于项目构建验证
  - 添加 `bun run type-check` 命令用于 TypeScript 类型检查

#### 📈 性能提升

- **代码行数减少**: 总计减少约 30% 的代码行数
- **性能改进**: 减少重复的字符串操作和条件判断
- **内存优化**: 更高效的字符串处理逻辑

#### 🛠️ Claude API 流式响应修复

- **修复 Claude API 流式响应解析**:
  - 正确处理 `content_block_delta` 事件中的 `text_delta` 内容
  - 支持 `input_json_delta` 类型的工具调用内容解析
  - 改进工具调用内容的合成显示格式

- **SSE 格式兼容性增强**:
  - 支持标准 `data: ` 格式和紧凑 `data:` 格式
  - 提升与不同上游服务的兼容性

#### 🧪 质量保证

- **类型安全**: 所有修改通过 TypeScript 类型检查
- **构建验证**: 确保所有优化不影响功能完整性
- **向后兼容**: 保持所有现有 API 接口不变

### 🔄 技术债务清理

这次更新严格遵循了软件工程最佳实践：

- **KISS 原则**: 追求代码和设计的极致简洁
- **DRY 原则**: 消除重复代码，统一处理逻辑  
- **YAGNI 原则**: 删除未使用的代码分支
- **函数式编程**: 优先使用函数式方法处理数据转换

---

## v1.0.0 - 2025-09-13

### 🎉 初始版本发布

这是 Claude API 代理服务器的第一个稳定版本。

#### ✨ 主要功能

- **多上游支持**: 内置 `openai`, `openaiold`, `gemini`, 和 `claude` 提供商，实现协议转换。
- **配置管理**:
  - 通过 `config.json` 文件管理上游服务。
  - 提供 `bun run config` 命令行工具，用于动态增、删、改、查上游配置。
  - 支持配置热重载，修改配置无需重启服务。
- **负载均衡**:
  - 支持对单个上游内的多个 API 密钥进行负载均衡。
  - 提供 `round-robin`（轮询）、`random`（随机）和 `failover`（故障转移）三种策略。
- **统一访问入口**: 所有请求通过 `/v1/messages` 代理，简化客户端配置。
- **全面的 API 兼容性**:
  - 支持流式（stream）和非流式响应。
  - 支持工具调用（Tool Use）。
- **环境配置**: 通过 `.env` 文件管理服务器端口、日志级别、访问密钥等。
- **部署与开发**:
  - 提供 `bun run dev` 开发模式，支持源码修改后自动重启。
  - 提供详细的 `README.md` 和 `DEVELOPMENT.md` 文档，包含 PM2 和 Docker 的部署指南。
- **健壮性与监控**:
  - 内置 `/health` 健康检查端点。
  - 详细的请求与响应日志系统。
  - 对上游流式响应中的错误进行捕获和处理。
